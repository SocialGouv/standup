include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops.yml
    ref: v20.7.10

variables:
  AUTO_DEVOPS_ENABLE_KAPP: "🕹️"

# Fake job
Install:
  script:
    - echo "It Works!"

# Disabled jobs
Lint:
  rules:
    - when: never
Test:
  rules:
    - when: never
K8S Test:
  rules:
    - when: never
Build:
  rules:
    - when: never
Register image:
  rules:
    - when: never
Register Kaniko image:
  rules:
    - when: never
Review:
  rules:
    - when: never
Trigger Release:
  rules:
    - when: never

# On $DEPLOY jobs
Notify Starting Deployment:
  extends: .autodevops_notify_starting_deployment
  rules:
    - if: "$DEPLOY"
      when: on_success
    - when: never

Notify Fail:
  extends: .autodevops_notify_fail
  rules:
    - if: "$DEPLOY"
      when: on_failure
    - when: never

Notify Success:
  extends: .autodevops_notify_success
  rules:
    - if: "$DEPLOY"
      when: on_success
    - when: never

Stop review:
  rules:
    - if: "$DEPLOY"
      when: manual
    - when: never

.autodevops_review:
  extends:
    - .deploy_stage
  rules:
    - if: "$PRODUCTION || $RELEASE || $CI_COMMIT_TAG"
      when: never
    - if: "$DEPLOY"
      when: always
    - when: never
  variables:
    KOSKO_APPEND_YAML_FROM: .k8s/environments/dev/manifests
    KOSKO_GENERATE_ARGS: >-
      --env dev
  environment:
    auto_stop_in: 1 day
    name: ${CI_COMMIT_REF_NAME}${AUTO_DEVOPS_DEV_ENVIRONMENT_NAME}
    on_stop: Stop review
    url: https://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}

Deploy:
  extends: .autodevops_review
